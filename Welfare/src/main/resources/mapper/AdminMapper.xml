<?xml version="1.0" encoding="UTF-8"?>
<!DOCTYPE mapper PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN"
"http://mybatis.org/dtd/mybatis-3-mapper.dtd">

<mapper namespace="com.greenart.bdproject.mapper.AdminMapper">

    <!-- 전체 회원 수 조회 -->
    <select id="getTotalMembers" resultType="int">
        SELECT COUNT(*)
        FROM member
    </select>

    <!-- 총 기부금 조회 (완료된 기부만) -->
    <select id="getTotalDonations" resultType="long">
        SELECT COALESCE(SUM(amount), 0)
        FROM donations
        WHERE payment_status = 'COMPLETED'
    </select>

    <!-- 봉사 신청 수 조회 -->
    <select id="getTotalVolunteers" resultType="int">
        SELECT COUNT(*)
        FROM vol_apply
    </select>

    <!-- 회원 목록 조회 -->
    <select id="getAllMembers" resultType="hashmap">
        SELECT
            member_id AS memberId,
            email AS userId,
            pwd,
            name,
            email,
            phone,
            role,
            birth,
            COALESCE(status, 'ACTIVE') AS status,
            DATE_FORMAT(created_at, '%Y-%m-%d %H:%i') AS createdAt,
            DATE_FORMAT(last_login_at, '%Y-%m-%d %H:%i') AS lastLoginAt,
            DATE_FORMAT(updated_at, '%Y-%m-%d %H:%i') AS statusUpdatedAt
        FROM member
        ORDER BY
            CASE WHEN role = 'ADMIN' THEN 0 ELSE 1 END,
            created_at DESC
    </select>

    <!-- 공지사항 목록 조회 -->
    <select id="getAllNotices" resultType="hashmap">
        SELECT
            notice_id AS noticeId,
            admin_id AS adminId,
            title,
            content,
            views,
            pinned_yn AS isPinned,
            DATE_FORMAT(created_at, '%Y-%m-%d') AS createdAt
        FROM notice
        ORDER BY pinned_yn DESC, created_at DESC
    </select>

    <!-- FAQ 목록 조회 -->
    <select id="getAllFaqs" resultType="hashmap">
        SELECT
            f.faq_id AS faqId,
            fc.category_name AS category,
            f.question,
            f.answer,
            f.order_num AS orderNum,
            f.active_yn AS isActive,
            DATE_FORMAT(f.created_at, '%Y-%m-%d') AS createdAt
        FROM faq f
        LEFT JOIN faq_categories fc ON f.cat_id = fc.category_id
        ORDER BY f.order_num ASC, f.created_at DESC
    </select>

    <!-- 기부 내역 조회 -->
    <select id="getAllDonations" resultType="hashmap">
        SELECT
            d.donation_id AS donationId,
            d.member_id AS userId,
            d.amount,
            d.donation_type AS donationType,
            dc.category_name AS category,
            d.package_name AS packageName,
            d.donor_name AS donorName,
            d.donor_email AS donorEmail,
            d.donor_phone AS donorPhone,
            d.message,
            COALESCE(d.payment_method, 'CREDIT_CARD') AS paymentMethod,
            d.payment_status AS paymentStatus,
            DATE_FORMAT(d.created_at, '%Y-%m-%d %H:%i') AS createdAt
        FROM donations d
        LEFT JOIN donation_categories dc ON d.category_id = dc.category_id
        ORDER BY d.created_at DESC
    </select>

    <!-- 봉사 신청 내역 조회 (신청대기 상태 우선 정렬) -->
    <select id="getAllVolunteers" resultType="hashmap">
        SELECT
            va.apply_id AS applicationId,
            va.act_id AS activityId,
            va.member_id AS userId,
            va.appl_name AS applicantName,
            va.appl_phone AS applicantPhone,
            va.appl_email AS applicantEmail,
            va.appl_addr AS applicantAddress,
            va.sel_cat AS selectedCategory,
            va.vol_exp AS volunteerExperience,
            va.motivation AS motivation,
            DATE_FORMAT(va.vol_date, '%Y-%m-%d') AS volunteerDate,
            DATE_FORMAT(va.vol_end_date, '%Y-%m-%d') AS volunteerEndDate,
            va.vol_time AS volunteerTime,
            va.status,
            va.assign_fac_nm AS assignedFacilityName,
            va.assign_fac_addr AS assignedFacilityAddress,
            va.admin_memo AS adminNote,
            DATE_FORMAT(va.appr_at, '%Y-%m-%d %H:%i') AS approvedAt,
            act.activity_name AS activityName,
            DATE_FORMAT(va.created_at, '%Y-%m-%d %H:%i') AS createdAt
        FROM vol_apply va
        LEFT JOIN volunteer_activities act ON va.act_id = act.activity_id
        ORDER BY
            CASE va.status
                WHEN 'APPLIED' THEN 1
                WHEN 'CONFIRMED' THEN 2
                WHEN 'COMPLETED' THEN 3
                WHEN 'REJECTED' THEN 4
                WHEN 'CANCELLED' THEN 5
                ELSE 6
            END,
            va.created_at DESC
    </select>

    <!-- 회원 정보 수정 -->
    <update id="updateMember" parameterType="map">
        UPDATE member
        SET name = #{name},
            phone = #{phone}
        WHERE email = #{userId}
    </update>

    <!-- 회원 탈퇴 처리 (소프트 삭제 - DORMANT 상태로 변경) -->
    <update id="deleteMember" parameterType="string">
        UPDATE member
        SET status = 'DORMANT',
            deleted_at = NOW(),
            updated_at = NOW()
        WHERE email = #{userId}
    </update>

    <!-- 회원 계정 정지 -->
    <update id="suspendMember" parameterType="string">
        UPDATE member
        SET status = 'SUSPENDED'
        WHERE email = #{userId}
    </update>

    <!-- 회원 계정 활성화 -->
    <update id="activateMember" parameterType="string">
        UPDATE member
        SET status = 'ACTIVE'
        WHERE email = #{userId}
    </update>

    <!-- 회원 상태 조회 (member_id로 조회) -->
    <select id="getMemberStatus" parameterType="long" resultType="map">
        SELECT
            member_id,
            email,
            name,
            status
        FROM member
        WHERE member_id = #{memberId}
    </select>

    <!-- 회원 상태 조회 (userId로 조회) -->
    <select id="getMemberStatusByUserId" parameterType="string" resultType="map">
        SELECT
            member_id,
            email,
            name,
            status,
            role
        FROM member
        WHERE email = #{userId}
    </select>

    <!-- 회원 상태 변경 -->
    <update id="updateMemberStatus" parameterType="map">
        UPDATE member
        SET status = #{status}
        WHERE email = #{userId}
    </update>

    <!-- 회원 등급 변경 -->
    <update id="updateMemberRole" parameterType="map">
        UPDATE member
        SET role = #{role}
        WHERE email = #{userId}
    </update>

    <!-- 봉사활동 승인 및 시설 배정 -->
    <update id="approveVolunteerApplication" parameterType="map">
        UPDATE vol_apply
        SET
            status = 'CONFIRMED',
            appr_by = (SELECT member_id FROM member WHERE email = #{adminUserId} LIMIT 1),
            appr_at = NOW(),
            assign_fac_nm = #{facilityName},
            assign_fac_addr = #{facilityAddress},
            admin_memo = #{adminNote}
        WHERE apply_id = #{applicationId}
    </update>

    <!-- 봉사활동 거절 -->
    <update id="rejectVolunteerApplication" parameterType="map">
        UPDATE vol_apply
        SET
            status = 'REJECTED',
            reject_rsn = #{reason}
        WHERE apply_id = #{applicationId}
    </update>

    <!-- ===== 대시보드 통계 관련 쿼리 ===== -->

    <!-- 오늘 기부 건수 -->
    <select id="getTodayDonationCount" resultType="int">
        SELECT COUNT(*)
        FROM donations
        WHERE DATE(created_at) = CURDATE()
        AND payment_status = 'COMPLETED'
    </select>

    <!-- 이번 달 진행된 봉사활동 수 -->
    <select id="getActiveVolunteerCount" resultType="int">
        SELECT COUNT(*)
        FROM vol_apply
        WHERE YEAR(vol_date) = YEAR(CURDATE())
        AND MONTH(vol_date) = MONTH(CURDATE())
    </select>

    <!-- 봉사 완료율 -->
    <select id="getVolunteerCompletionRate" resultType="double">
        SELECT
            CASE
                WHEN COUNT(*) = 0 THEN 0
                ELSE (COUNT(CASE WHEN status = 'COMPLETED' THEN 1 END) * 100.0 / COUNT(*))
            END as rate
        FROM vol_apply
    </select>

    <!-- 활동 중인 회원 수 -->
    <select id="getActiveMembers" resultType="int">
        SELECT COUNT(*)
        FROM member
        WHERE status = 'ACTIVE'
        AND deleted_at IS NULL
    </select>

    <!-- ===== 대시보드 차트 관련 쿼리 ===== -->

    <!-- 월별 기부금 추이 (최근 6개월) -->
    <select id="getMonthlyDonationTrend" resultType="map">
        SELECT
            DATE_FORMAT(m.month_date, '%c월') as month,
            COALESCE(SUM(d.amount), 0) as amount
        FROM (
            SELECT DATE_FORMAT(DATE_SUB(CURDATE(), INTERVAL n MONTH), '%Y-%m-01') as month_date
            FROM (SELECT 0 n UNION SELECT 1 UNION SELECT 2 UNION SELECT 3 UNION SELECT 4 UNION SELECT 5) numbers
        ) m
        LEFT JOIN donations d ON DATE_FORMAT(d.created_at, '%Y-%m') = DATE_FORMAT(m.month_date, '%Y-%m')
            AND d.payment_status = 'COMPLETED'
        GROUP BY m.month_date
        ORDER BY m.month_date
    </select>

    <!-- 회원 증가 추이 (최근 6개월) - 신규 회원만 표시 -->
    <select id="getMemberGrowthTrend" resultType="map">
        SELECT
            DATE_FORMAT(m.month_date, '%c월') as month,
            COUNT(CASE WHEN DATE_FORMAT(mb.created_at, '%Y-%m') = DATE_FORMAT(m.month_date, '%Y-%m') THEN 1 END) as new_members
        FROM (
            SELECT DATE_FORMAT(DATE_SUB(CURDATE(), INTERVAL n MONTH), '%Y-%m-01') as month_date
            FROM (SELECT 0 n UNION SELECT 1 UNION SELECT 2 UNION SELECT 3 UNION SELECT 4 UNION SELECT 5) numbers
        ) m
        LEFT JOIN member mb ON DATE_FORMAT(mb.created_at, '%Y-%m') = DATE_FORMAT(m.month_date, '%Y-%m')
        GROUP BY m.month_date
        ORDER BY m.month_date
    </select>

    <!-- 봉사활동 카테고리별 통계 -->
    <select id="getVolunteerCategoryStats" resultType="map">
        SELECT
            CASE sel_cat
                WHEN 'ELDERLY' THEN '노인돌봄'
                WHEN 'CHILD' THEN '아동교육'
                WHEN 'ENVIRONMENT' THEN '환경보호'
                WHEN 'DISABLED' THEN '의료봉사'
                WHEN 'COMMUNITY' THEN '재난구호'
                WHEN 'EDUCATION' THEN '문화행사'
                ELSE '기타'
            END as category,
            CASE
                WHEN (SELECT COUNT(*) FROM vol_apply) = 0 THEN 0
                ELSE COUNT(*) * 100.0 / (SELECT COUNT(*) FROM vol_apply)
            END as rate
        FROM vol_apply
        GROUP BY sel_cat
        ORDER BY rate DESC
        LIMIT 6
    </select>

    <!-- 월별 봉사활동 현황 (최근 6개월) -->
    <select id="getMonthlyVolunteerStats" resultType="map">
        SELECT
            DATE_FORMAT(m.month_date, '%c월') as month,
            COUNT(v.apply_id) as count
        FROM (
            SELECT DATE_FORMAT(DATE_SUB(CURDATE(), INTERVAL n MONTH), '%Y-%m-01') as month_date
            FROM (SELECT 0 n UNION SELECT 1 UNION SELECT 2 UNION SELECT 3 UNION SELECT 4 UNION SELECT 5) numbers
        ) m
        LEFT JOIN vol_apply v ON DATE_FORMAT(v.created_at, '%Y-%m') = DATE_FORMAT(m.month_date, '%Y-%m')
        GROUP BY m.month_date
        ORDER BY m.month_date
    </select>

    <!-- 월별 봉사 후기 통계 -->
    <select id="getMonthlyVolunteerReviewStats" resultType="map">
        SELECT
            DATE_FORMAT(created_at, '%Y-%m') as month,
            COUNT(*) as count
        FROM vol_review
        WHERE deleted_at IS NULL
          AND created_at >= DATE_SUB(CURDATE(), INTERVAL 6 MONTH)
        GROUP BY DATE_FORMAT(created_at, '%Y-%m')
        ORDER BY month
    </select>

    <!-- 월별 기부 후기 통계 -->
    <select id="getMonthlyDonationReviewStats" resultType="map">
        SELECT
            DATE_FORMAT(created_at, '%Y-%m') as month,
            COUNT(*) as count
        FROM donation_reviews
        WHERE is_visible = TRUE
          AND created_at >= DATE_SUB(CURDATE(), INTERVAL 6 MONTH)
        GROUP BY DATE_FORMAT(created_at, '%Y-%m')
        ORDER BY month
    </select>

    <!-- 복지서비스 이용 통계 -->
    <select id="getWelfareServiceStats" resultType="map">
        SELECT '기부' as service_type, COUNT(*) as count FROM donations WHERE payment_status = 'COMPLETED'
        UNION ALL
        SELECT '봉사' as service_type, COUNT(*) as count FROM vol_apply
        UNION ALL
        SELECT '복지지도' as service_type, COUNT(*) as count FROM favorite_welfare_services
        UNION ALL
        SELECT '복지진단' as service_type, COUNT(*) as count FROM welfare_diagnosis_log
    </select>

    <!-- 기부 카테고리별 분포 (상위 9개 카테고리: 위기가정~범죄피해) -->
    <select id="getDonationCategoryStats" resultType="map">
        SELECT
            dc.category_name as category,
            COALESCE(SUM(d.amount), 0) as amount
        FROM donation_categories dc
        LEFT JOIN donations d ON dc.category_id = d.category_id AND d.payment_status = 'COMPLETED'
        WHERE dc.is_active = TRUE
        AND dc.display_order &lt;= 9
        GROUP BY dc.category_id, dc.category_name, dc.display_order
        ORDER BY dc.display_order ASC
    </select>

    <!-- 봉사 신청 정보 조회 (알림 발송용) -->
    <select id="getVolunteerApplicationById" parameterType="long" resultType="map">
        SELECT
            va.apply_id AS applicationId,
            va.member_id AS memberId,
            m.email AS userEmail,
            va.appl_name AS applicantName,
            va.sel_cat AS selectedCategory,
            DATE_FORMAT(va.vol_date, '%Y-%m-%d') AS volunteerDate,
            va.vol_time AS volunteerTime,
            va.status,
            va.assign_fac_nm AS assignedFacilityName,
            va.assign_fac_addr AS assignedFacilityAddress,
            va.admin_memo AS adminNote
        FROM vol_apply va
        LEFT JOIN member m ON va.member_id = m.member_id
        WHERE va.apply_id = #{applicationId}
    </select>

    <!-- 시간 경과된 봉사활동 자동 완료 처리 -->
    <update id="completeExpiredVolunteerApplications">
        UPDATE vol_apply
        SET status = 'COMPLETED'
        WHERE status = 'CONFIRMED'
        AND CONCAT(vol_date, ' ',
            CASE vol_time
                WHEN 'MORNING' THEN '12:00:00'
                WHEN 'AFTERNOON' THEN '18:00:00'
                WHEN 'EVENING' THEN '22:00:00'
                ELSE '23:59:59'
            END) &lt; NOW()
    </update>

</mapper>
